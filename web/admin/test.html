<!DOCTYPE html>
<html lang="en">
    <head>
        <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:500,700' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700' rel='stylesheet' type='text/css'>
        <style>
            :root {
                --main-text-color: #0b0b0b;
                --border-color: #5f5f5f;
            }
            * {
                font-family: 'Source Sans Pro', sans-serif;
            }
            html, body {
                background-color: #f3f3f3;
                color: var(--main-text-color);
            }
            body {
                padding: 50px 120px;
            }
            h1 {
                font-weight: normal;
                font-size: 28px;
            }
            p {
                font-size: 20px;
            }
            .fixed {
                font-family: 'Source Code Pro', sans-serif;
                font-weight: normal;
            }
            td {
                min-width: 150px;
                height: 40px;
                padding: 4px;
                margin: 4px;
            }
            tr {
                margin: 4px;
            }
            tr td div.result {
                display: none;
            }
            tr.success td div.result {
                display: inherit;
            }
            tr.failure td div.result {
                display: inherit;
            }
            tr.success td:last-of-type {
                background-color: #a3d1a5;
                border-style: dashed;
                border-width: 1px;
                border-color: var(--border-color);
                border-radius: 5px;
            }
            tr.success td:last-of-type div.button {
                display: none;
            }
            tr.failure td:last-of-type div.button {
                display: none;
            }
            tr.failure td:last-of-type {
                background-color: #db9f9f;
            }
            td:nth-child(1) {
                width: 300px;
            }
            .button {
                float: left;
                margin-right: 10px;
                border-style: dashed;
                border-width: 1px;
                border-color: var(--border-color);
                border-radius: 5px;
                background-color: antiquewhite;
                padding: 6px 10px;
                font-family: 'Source Code Pro', sans-serif;
                font-weight: bold;
                text-decoration: none;
                cursor: pointer; 
            }
            a:link, a:visited, a:active, a:hover {
                color: var(--main-text-color);
                text-decoration: none;
            }
        </style>
    </head>
    <body>
        <h1><span class="fixed">eventPresent</span></h1>
        <template><tr class="test"><td>Connect WebSocket</td><td><div class="button">GO</div><a><div class="result"></div></a></td></tr></template>

        <table>
            <tr><td><p>Test Suite</p></td><td><a onclick="runtests()"><div class="button">GO</div></a><a onclick="resettests()"><div class="button">RESET</div></a></td></tr>
        </table>
    </body>
    <script type="application/javascript" src="/lib/mqttws31.min.js"></script>
    <script>
        // let apass = prompt("Admin password:");
        // nanoid
        const nanoid = (t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce(((t,e)=>t+=(e&=63)<36?e.toString(36):e<62?(e-26).toString(36).toUpperCase():e>62?"-":"_"),"");
        const unid = nanoid(10);
    </script>
    
    <script type="application/javascript">
        "use strict;"
        let tests = [
            // basics
            { n: "Nano ID Create",    f: function(cb, index) { const nid = nanoid(10); cb(index, nid.length === 10, nid) } },
            
            { n: "Create WebSocket Client",    f: (cb, index) => { const ws = new WebSocket("ws://localhost:8080/ws"); cb(index, ws instanceof WebSocket); } },
            
            { n: "Connect WebSocket Client",   f: (cb, index) => { const ws = new WebSocket("ws://localhost:8080/ws"); ws.onopen = function() { cb(index, true) }; ws.onerror = function (err) { cb(index, false, "Connection failed: " + err) }; } },
            
            { n: "Create MQTT Client",         f: (cb, index) => { const mqtt = new Paho.MQTT.Client(location.hostname, 8090, unid); cb(index, mqtt instanceof Paho.MQTT.Client ) } },
            
            // Paho (or something) throws a console error on disconnect, so lame.
            { n: "Connect MQTT Client",        f: (cb, index) => { const mqtt = new Paho.MQTT.Client(location.hostname, 8090, unid); mqtt.connect({ onSuccess: async function() { cb(index, mqtt.isConnected()); }, onFailure: function(err) { cb(index, false, err.errorMessage)} }) }},

            { n: "MQTT roundtrip ping",        f: (cb, index) => { const mqtt = new Paho.MQTT.Client(location.hostname, 8090, unid); mqtt.connect({ onSuccess: async function() { mqtt.subscribe('user/out/' + unid); mqtt.onMessageArrived = function(msg) { console.log(msg); cb(index, JSON.parse(msg.payloadString).nid === unid ) }; mqtt.send('user/in', `{"t": "ping", "nid": "${unid}" }`); }, onFailure: function(err) { cb(index, false, err.errorMessage)} }) }},
            
            // test retained state message
            
            // load test ping
            
            // test MQTT message retain
            
        ];

        let template = document.getElementsByTagName("template")[0];
        let rowtemplate = template.content.querySelector("tr");
        let table = document.querySelector("table");

        window.onload = function() {
            // create list of tests
            tests.forEach((test, index) => {
                let row = document.importNode(rowtemplate, true);
                row.querySelectorAll('td')[0].textContent = test.n;
                row.querySelectorAll('td div.button')[0].setAttribute('onclick',  `runtests(${index})`);
                table.appendChild(row);
            });
        }
        
        function resettests() {
            tests.forEach((test, index) => {
                toggletest(index, 0, 0, true);
            });
        }
        
        async function runtests(testnum) {
            let cb = function(index, success, message) {
                message = (typeof message === 'undefined') ? "" : message;
                toggletest(index, success, message);
            }
            if (testnum !== undefined) {
                tests[testnum].f(cb, testnum);
            }
            else // run them all
            {
                for (let i = 0; i < tests.length; i++) {
                    tests[i].f(cb, i);
                    await sleep(500);
                };
            }
        }
        
        function toggletest(index, success, message, clear) {
            let tr = document.querySelectorAll("tr")[index+1];
            if (clear) {
                tr.classList.remove('success');
                tr.classList.remove('failure');
            }
            else if (success) {
                tr.classList.remove('failure');
                tr.classList.add('success');
                tr.querySelectorAll("td")[1].querySelector("div.result").textContent = success;
            }
            else {
                console.log(message);
                tr.classList.remove('success');
                tr.classList.add('failure');
                tr.querySelectorAll("td")[1].querySelector("div.result").textContent = message;
            }
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
    </script>
    
</html>
